/*! SemTag - v0.0.1 - 2012-10-10
* https://github.com/EivindEE/SemTag
* Copyright (c) 2012 Eivind Elseth; Licensed  */
var semtag=function(e,t){"use strict";if(!e)throw{name:"MissingArgumentsException",message:"Function requires a valid container argument"};if(e instanceof HTMLElement){var n={extractor:{}},r=function(e,t){console.log(e===t);var n;return t.parentElement?(n=t.parentElement,e===n?t:r(e,n)):!1},i,s,o=0;return t=t||{},i=t.nodeName||"span",s=t.className||"semtag",n.ancestorOrSelf=function(e,t){return e===t?!0:t.parentNode?this.ancestorOrSelf(e,t.parentNode):!1},n.legalRange=function(e){var t=e.cloneRange(),n,i,s;return e.startContainer===e.endContainer?t:(n=r(e.endContainer.parentElement,e.startContainer.parentElement),n?(t.setStartBefore(n),t):(n=r(e.startContainer.parentElement,e.endContainer.parentElement),n?(t.setEndAfter(n),t):(console.log("*****"),console.log(e.commonAncestorContainer),console.log(e.startContainer),console.log(e.endContainer),i=r(e.commonAncestorContainer,e.startContainer),s=r(e.commonAncestorContainer,e.endContainer),t.setStartBefore(i),t.setEndAfter(s),t)))},n.surround=function(e){if(!e)throw{name:"MissingArgumentsException",message:"Function requires a range object to surround with tags"};var t=document.createElement(i);return t.className=s,t.setAttribute("id",s+o),o+=1,t.appendChild(e),t},n.extract=function(){var t,n=[],r=e.getElementsByClassName(s),i=r.length;for(t=0;t<i;t+=1)n[t]=r[t].cloneNode(!0);return n},n.tagSelection=function(){var t=window.getSelection(),r,i,s;if(t.rangeCount>0){r=t.getRangeAt(0);if(!n.ancestorOrSelf(e,r.commonAncestorContainer))throw{name:"InvalidSelectionException",message:"Selection is outside of the scope of the semtag container"};return i=r.extractContents(),s=n.surround(i),r.insertNode(s),s}throw{name:"InvalidSelectionException",message:"Function should not be called when nothing is selected"}},n.correctSelection=function(){var t=window.getSelection(),r,i,s;if(t.rangeCount>0){r=t.getRangeAt(0),i=r.startContainer,s=r.endContainer;if(n.ancestorOrSelf(e,i)&&n.ancestorOrSelf(e,s))return i.parentElement!==s.parentElement?(r=n.legalRange(r),t.removeAllRanges(),t.addRange(r),r):r;throw{name:"InvalidSelectionException",message:"Selection must be fully within the container"}}},{correctSelection:n.correctSelection,tagSelection:n.tagSelection,extract:n.extract,surround:n.surround,legalRange:n.legalRange,ancestorOrSelf:n.ancestorOrSelf}}throw{name:"InvalidTypeException",message:"Container must be a HTMLElement"}},semtag=semtag||{};semtag.buildTag=function(e,t,n){"use strict";var r,i,s;return i=n.type||"div",s=n.className||"",r=document.createElement(i),r.setAttribute("id",e),r.className=s,document.getElementById(t).appendChild(r),r},semtag.getId=function(e){"use strict";var t,n,r=1;n="semtag-"+e.replace(/ /g,"_")+"-",t=n+r;while(document.getElementById(t))r+=1,t=n+r;return t},semtag.removeSense=function(e){"use strict";var t,n,r;t=e.parentNode.parentNode,n=t.parentNode,r=document.createTextNode(t.textContent),n.replaceChild(r,t)},semtag.wordSenseClicked=function(e){"use strict";var t,n,r,i,s;t=document.getElementById("toTag"),r=semtag.getId(t.textContent),n=e.getAttribute("id"),t.setAttribute("id",r),t.setAttribute("rel","http://purl.org/linguistics/gold/hasMeaning"),t.setAttribute("title",e.textContent),t.setAttribute("resource",n),t.setAttribute("about",document.URL+"#"+r),t.className="tagged",i=document.createElement("span"),i.className="remove",s=document.createElement("img"),s.setAttribute("src","/images/remove.png"),s.className="removeIcon",s.setAttribute("alt","X"),i.appendChild(s),t.appendChild(i),$(".removeIcon").unbind("click"),$(".removeIcon").click(function(){semtag.removeSense(this)})},semtag.buildDidYouMeanTable=function(e,t){"use strict";var n,r=e.senses.length,i,s,o,u;n=document.getElementById(t)||semtag.buildTag(t,"content-container",{className:"span4"}),s=document.getElementById("senses")||semtag.buildTag("senses",t,{type:"ul"}),u=document.createElement("h5"),u.innerText='When you say "'+e.word+'" did you mean:',n.innerHTML="",s.innerHTML="",n.appendChild(u);for(i=0;i<r;i+=1)o=document.createElement("li"),o.setAttribute("id",e.senses[i].senseid),o.className="word-sense",o.innerText=e.senses[i].explanation,s.appendChild(o);n.appendChild(s),$(".word-sense").click(function(){semtag.wordSenseClicked(this),n.parentNode.removeChild(n)})},semtag.sw=function(e){"use strict";e=e.replace(/^\s*|\s*$/g,""),e=e.replace(/ /g,"_"),$.getJSON('http://localhost:3000/lex?data={"word":"'+e+'"}',function(e){semtag.buildDidYouMeanTable(e,"dym")})},semtag.surround=function(e,t){"use strict";var n=e.extractContents(),r=document.createElement("span");r.setAttribute("id",t),r.appendChild(n),e.insertNode(r)},semtag.resetToTag=function(e,t){"use strict";var n,r,i;n=document.getElementById(e),n&&(i=n.childNodes[0],r=n.parentNode,i?r.replaceChild(i,n):r.removeChild(n)),t()},$("#content").mouseup(function(){"use strict";var e=window.getSelection().getRangeAt(0);e&&e.toString().length>0&&semtag.resetToTag("toTag",function(){semtag.surround(e,"toTag"),semtag.sw(e.toString()),document.getSelection().addRange(e)})});